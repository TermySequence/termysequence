# Copyright Â© 2018 TermySequence LLC
#
# SPDX-License-Identifier: GPL-2.0-only

IF (BUILD_QTGUI)
  FIND_PACKAGE(ICU 60 REQUIRED COMPONENTS i18n uc)

  IF (CMAKE_VERBOSE_MAKEFILE)
    SET(_verbose "VERBOSE=1")
  ENDIF()

  ADD_CUSTOM_TARGET(V8_build
    COMMAND make
    ARCH=${V8_ARCH}
    ARMFP=${V8_ARMFP}
    JOBS=${V8_JOBS}
    CFLAGS=${CMAKE_C_FLAGS}
    CXXFLAGS=${CMAKE_CXX_FLAGS}
    LDFLAGS=${CMAKE_STATIC_LINKER_FLAGS}
    BUILDDIR=${CMAKE_CURRENT_BINARY_DIR}/v8
    CC=${CMAKE_C_COMPILER}
    CXX=${CMAKE_CXX_COMPILER}
    AR=${CMAKE_AR}
    ${_verbose}
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/v8-linux)

  ADD_CUSTOM_TARGET(V8_clean
    COMMAND make
    BUILDDIR=${CMAKE_CURRENT_BINARY_DIR}/v8
    clean
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/v8-linux)

  ADD_LIBRARY(l::V8 INTERFACE IMPORTED GLOBAL)
  SET_TARGET_PROPERTIES(l::V8 PROPERTIES
    INTERFACE_INCLUDE_DIRECTORIES ${CMAKE_CURRENT_SOURCE_DIR}/v8-linux/v8/include)
  TARGET_LINK_LIBRARIES(l::V8 INTERFACE
    ${CMAKE_CURRENT_BINARY_DIR}/v8/obj/libv8_libplatform.a
    ${CMAKE_CURRENT_BINARY_DIR}/v8/obj/libv8_base.a
    ${CMAKE_CURRENT_BINARY_DIR}/v8/obj/libv8_external_snapshot.a
    ${CMAKE_CURRENT_BINARY_DIR}/v8/obj/libv8_libbase.a
    ${CMAKE_CURRENT_BINARY_DIR}/v8/obj/libv8_libsampler.a
    ICU::i18n ICU::uc)

  INSTALL(FILES
    ${CMAKE_CURRENT_BINARY_DIR}/v8/natives_blob.bin
    ${CMAKE_CURRENT_BINARY_DIR}/v8/snapshot_blob_trusted.bin
    DESTINATION ${CMAKE_INSTALL_DATADIR}/${APP_NAME}/v8)

  ADD_CUSTOM_TARGET(install_emoji
    COMMAND make APP_NAME=${APP_NAME} DATADIR=${CMAKE_INSTALL_FULL_DATADIR} install
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/termy-emoji)

  ADD_CUSTOM_TARGET(install_icons
    COMMAND make APP_NAME=${APP_NAME} DATADIR=${CMAKE_INSTALL_FULL_DATADIR} install
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/termy-icon-theme)
ENDIF()

IF (BUILD_SERVER)
  FILE(GLOB shell_FILES iTerm2/iterm2_shell_integration.*)
  INSTALL(FILES ${shell_FILES}
    DESTINATION ${CMAKE_INSTALL_DATADIR}/${SERVER_NAME})
ENDIF()
